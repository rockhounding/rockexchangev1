<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rockhounding for Beginners - Rock Exchange</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #151a22;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 6px;
    }

    p.subtitle {
      text-align: center;
      font-size: 12px;
      color: #bbbbbb;
      margin-top: 0;
      margin-bottom: 20px;
    }

    .card {
      background: #202837;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      margin-bottom: 18px;
    }

    .code-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }

    .code-row label {
      font-size: 14px;
    }

    input[type="text"], input[type="password"], select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #0f1420;
      color: #f5f5f5;
      box-shadow: inset 0 0 0 1px #333;
      font-size: 15px;
    }

    input[type="text"], input[type="password"] {
      letter-spacing: 1px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      resize: vertical;
      font-family: monospace;
      font-size: 13px;
      background: #0f1420;
      color: #f5f5f5;
      box-shadow: inset 0 0 0 1px #333;
    }

    button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    button:hover {
      background: #5ec660;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: #3f51b5;
    }

    .btn-danger {
      background: #c62828;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      margin-top: 0;
      margin-right: 4px;
    }

    .status {
      margin-top: 10px;
      min-height: 18px;
      font-size: 13px;
      text-align: center;
    }

    .status.error {
      color: #ff8a80;
    }

    .status.success {
      color: #9cff9c;
    }

    .result-card {
      margin-top: 14px;
      background: #181f2c;
      border-radius: 10px;
      padding: 14px;
      box-shadow: inset 0 0 0 1px #333;
      font-size: 14px;
      line-height: 1.4;
    }

    .result-card strong {
      color: #ffd54f;
    }

    .small-note {
      font-size: 11px;
      color: #bbb;
      margin-top: 10px;
      text-align: center;
    }

    .fade-in {
      animation: fadeIn 0.4s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .admin-header h2 {
      border-bottom: none;
      margin: 0;
      padding: 0;
      font-size: 18px;
    }

    .admin-small-note {
      font-size: 11px;
      color: #aaa;
      margin-top: 6px;
      text-align: left;
    }

    .list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    .list-table th, .list-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #333;
      text-align: left;
      vertical-align: top;
    }

    .list-table th {
      background: #1a2231;
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
    }

    .badge-sent {
      background: #ffca28;
      color: #000;
    }

    .badge-not-sent {
      background: #555;
      color: #eee;
    }

    .badge-approved {
      background: #66bb6a;
      color: #000;
    }

    .badge-not-approved {
      background: #b0bec5;
      color: #000;
    }

    .badge-tracking {
      background: #26c6da;
      color: #000;
    }

    .badge-no-tracking {
      background: #616161;
      color: #eee;
    }

    .clickable {
      cursor: pointer;
    }

    .address-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }

    .address-grid label {
      font-size: 13px;
    }

    .address-grid input, .address-grid select {
      width: 100%;
      text-align: left;
      letter-spacing: 0;
    }

    .preview-row-selected {
      background: #334155 !important;
    }

    /* ===== Mobile + Modern Patch (add at VERY bottom) ===== */

    /* 1) Make inputs/buttons consistent + mobile friendly */
    input[type="text"], input[type="password"], select, textarea, button {
    font-size: 16px; /* prevents iPhone zoom on focus */
    }

    button {
    min-height: 44px; /* better tap target */
    }

    /* 2) Stop the "centered like a terminal window" look on phones */
    body {
    display: block;            /* removes the flex centering */
    align-items: initial;
    }

    .container {
    margin: 0 auto;
    padding: 16px;
    }

    /* 3) Make cards breathe more on mobile */
    .card {
    margin-bottom: 14px;
    padding: 16px;
    }

    /* 4) Your address grid should collapse to 1 column on phones */
    @media (max-width: 720px) {
    .address-grid {
        grid-template-columns: 1fr;
    }

    .code-row {
        justify-content: stretch;
    }

    .code-row input,
    .code-row select,
    .code-row button {
        width: 100%;
    }

    .list-table {
        display: block;
        overflow-x: auto;  /* tables scroll horizontally on small screens */
        -webkit-overflow-scrolling: touch;
    }
    }
    /* ===== FIX: overlap + off-screen inputs (paste at very bottom) ===== */

    /* 1) Prevent ‚Äúwide‚Äù inputs from overflowing their container */
    * { box-sizing: border-box; }
    input, select, textarea, button { max-width: 100%; }

    /* 2) Give every input row consistent spacing */
    .address-grid {
    gap: 12px 14px;   /* more breathing room so fields don't "touch" */
    }

    /* 3) Ensure grid items can shrink properly (common overlap fix) */
    .address-grid > div,
    .address-grid label,
    .address-grid input,
    .address-grid select {
    min-width: 0;
    }

    /* 4) Make labels not crowd inputs */
    .address-grid label {
    display: block;
    margin-bottom: 6px;
    }

    /* 5) Symmetric padding on phone + stop ‚Äúright edge hugs‚Äù */
    .container {
    padding-left: 16px;
    padding-right: 16px;
    }

    /* 6) On small screens, stack fields and force full-width */
    @media (max-width: 720px) {
    .address-grid { grid-template-columns: 1fr; }

    input[type="text"],
    input[type="password"],
    select,
    textarea {
        width: 100%;
    }
    }

    /* ===== Form alignment + no spill (paste at bottom) ===== */

    /* Make the form box always fit inside its parent */
    #signupForm { width: 100%; }

    /* Treat each field group consistently (label above input) */
    #signupForm > div {
    margin-bottom: 12px !important;
    }

    /* Labels: consistent spacing, no weird gaps */
    #signupForm label,
    .address-grid label {
    display: block;
    margin: 0 0 6px !important;
    line-height: 1.2;
    }

    /* Inputs/selects: full width but never spill */
    #signupForm input,
    #signupForm select,
    #signupForm textarea,
    .address-grid input,
    .address-grid select {
    display: block;
    width: 100%;
    max-width: 100%;
    }

    /* Remove the effect of <br> making things look separated */
    #signupForm br,
    .address-grid br { display: none; }

    /* Address grid: ensure columns don't overflow */
    .address-grid > div { min-width: 0; }

    /* Fix the special code input width so it doesn't break alignment */
    #signupCode { width: 160px !important; max-width: 100%; }

    /* Center the code field block cleanly (optional but looks nicer) */
    #signupCode {
    text-align: center;
    }

    /* Mobile: stop iPhone ‚Äúauto zoom‚Äù + keep padding symmetric */
    @media (max-width: 720px){
    #signupForm { padding: 0; }
    input, select, textarea { font-size: 16px; }
    }

    /* ===== LIGHT THEME OVERRIDE (paste at very bottom) ===== */

    body{
    background:#f3f6fb;
    color:#1f2937;
    }

    h1{ color:#0f172a; }
    p.subtitle{ color:#475569; }

    .card{
    background:#ffffff;
    border: 1px solid #dbe3ef;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    .small-note{ color:#475569; }
    .admin-small-note{ color:#475569; }

    input[type="text"], input[type="password"], select{
    background:#ffffff;
    color:#111827;
    box-shadow: inset 0 0 0 1px #cbd5e1;
    }

    textarea{
    background:#ffffff;
    color:#111827;
    box-shadow: inset 0 0 0 1px #cbd5e1;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    input:focus, select:focus, textarea:focus{
    outline:none;
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15), inset 0 0 0 1px #2563eb;
    }

    /* Buttons: calmer, modern */
    button{
    background:#2563eb;
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.18);
    }

    button:hover{ background:#1d4ed8; }
    .btn-secondary{ background:#0f766e; }
    .btn-secondary:hover{ background:#115e59; }

    .btn-danger{ background:#dc2626; }
    .btn-danger:hover{ background:#b91c1c; }

    /* Status colors for light bg */
    .status.error{ color:#b91c1c; }
    .status.success{ color:#166534; }

    /* Result card on light bg */
    .result-card{
    background:#f8fafc;
    box-shadow: inset 0 0 0 1px #dbe3ef;
    }

    .result-card strong{ color:#b45309; }

    /* Table on light bg */
    .list-table th, .list-table td{
    border-bottom: 1px solid #e5e7eb;
    }

    .list-table th{
    background:#f1f5f9;
    }

    /* Badges tuned for light bg */
    .badge-not-sent{ background:#e5e7eb; color:#111827; }
    .badge-not-approved{ background:#e2e8f0; color:#111827; }
    .badge-no-tracking{ background:#e5e7eb; color:#111827; }

    /* Your selected preview row */
    .preview-row-selected{
    background:#dbeafe !important;
    }

  </style>
</head>
<body autocomplete="off">
<div class="container">
  <h1>Rockhounding for Beginners - Rock Exchange</h1>
  <p class="subtitle">
    Before the deadline: sign up and mark your deposit. After assignments are generated, use your code to reveal who you are sending rocks to and submit your tracking number.
  </p>

  <!-- Card 1: Reveal OR Sign-up (toggled by settings) -->
  <div class="card">
    <!-- Reveal section (shown AFTER assignments are generated) -->
    <div id="revealSection" style="display:none;">
      <h2 style="margin-top:0;">1. Reveal Your Match</h2>
      <p class="small-note" style="margin-top:2px;">
        Enter the same 4-digit code you used when signing up to see who you are sending your rocks to.
      </p>
      <div class="code-row">
        <label for="revealCodeInput">Your code:</label>
        <input id="revealCodeInput" type="text" maxlength="8" autocomplete="off" inputmode="numeric"
               placeholder="1234" style="width:160px;">
        <button id="revealBtn">‚ú® Reveal My Match</button>
      </div>
      <div id="revealStatus" class="status"></div>
      <div id="revealResultCard" class="result-card" style="display:none;"></div>

      <!-- Tracking section (visible after a successful reveal) -->
      <div id="trackingSection" style="display:none; margin-top:10px;">
        <p class="small-note">
          After you have mailed your box, enter your tracking number below so the organizer can confirm and refund your deposit.
        </p>
        <div class="code-row">
          <label for="trackingInput">Tracking #:</label>
          <input id="trackingInput" type="text" autocomplete="off"
                 placeholder="e.g. 9400 1234 5678 9000 0000 00" style="min-width:260px;">
          <button id="submitTrackingBtn" class="btn-secondary">üì¶ Submit Tracking</button>
        </div>
        <div id="trackingStatus" class="status"></div>
        <div id="incomingTrackingDisplay" class="small-note" style="margin-top:4px;"></div>
      </div>
    </div>

    <!-- Signup + deposit section (shown BEFORE assignments are generated) -->
    <div id="signupSection">
      <h2 style="margin-top:0;">1. Sign Up</h2>
      <div id="signupIntro" style="text-align:center;margin-bottom:10px;">
        <button id="showSignupBtn">üìù Sign Up for This Exchange</button>
      </div>

      <form id="signupForm" style="display:none;max-width:700px;margin:0 auto;">
        <div style="margin-bottom:8px;">
          <label for="signupName" style="font-size:14px;">Name:</label><br>
          <input id="signupName" type="text" autocomplete="off" style="width:100%;text-align:left;">
        </div>
        <div style="margin-bottom:4px;margin-top:8px;font-size:14px;">
        </div>
        <div class="address-grid">
          <div>
            <label for="signupStreet">Street</label><br>
            <input id="signupStreet" type="text" autocomplete="off" placeholder="412 17th Avenue">
          </div>
          <div>
            <label for="signupCity">City</label><br>
            <input id="signupCity" type="text" autocomplete="off" placeholder="Hinton">
          </div>
          <div>
            <label for="signupState">State/Province</label><br>
            <select id="signupState">
              <option value="">-- Select --</option>
              <!-- US states -->
              <option value="AL">Alabama (AL)</option>
              <option value="AK">Alaska (AK)</option>
              <option value="AZ">Arizona (AZ)</option>
              <option value="AR">Arkansas (AR)</option>
              <option value="CA">California (CA)</option>
              <option value="CO">Colorado (CO)</option>
              <option value="CT">Connecticut (CT)</option>
              <option value="DE">Delaware (DE)</option>
              <option value="FL">Florida (FL)</option>
              <option value="GA">Georgia (GA)</option>
              <option value="HI">Hawaii (HI)</option>
              <option value="ID">Idaho (ID)</option>
              <option value="IL">Illinois (IL)</option>
              <option value="IN">Indiana (IN)</option>
              <option value="IA">Iowa (IA)</option>
              <option value="KS">Kansas (KS)</option>
              <option value="KY">Kentucky (KY)</option>
              <option value="LA">Louisiana (LA)</option>
              <option value="ME">Maine (ME)</option>
              <option value="MD">Maryland (MD)</option>
              <option value="MA">Massachusetts (MA)</option>
              <option value="MI">Michigan (MI)</option>
              <option value="MN">Minnesota (MN)</option>
              <option value="MS">Mississippi (MS)</option>
              <option value="MO">Missouri (MO)</option>
              <option value="MT">Montana (MT)</option>
              <option value="NE">Nebraska (NE)</option>
              <option value="NV">Nevada (NV)</option>
              <option value="NH">New Hampshire (NH)</option>
              <option value="NJ">New Jersey (NJ)</option>
              <option value="NM">New Mexico (NM)</option>
              <option value="NY">New York (NY)</option>
              <option value="NC">North Carolina (NC)</option>
              <option value="ND">North Dakota (ND)</option>
              <option value="OH">Ohio (OH)</option>
              <option value="OK">Oklahoma (OK)</option>
              <option value="OR">Oregon (OR)</option>
              <option value="PA">Pennsylvania (PA)</option>
              <option value="RI">Rhode Island (RI)</option>
              <option value="SC">South Carolina (SC)</option>
              <option value="SD">South Dakota (SD)</option>
              <option value="TN">Tennessee (TN)</option>
              <option value="TX">Texas (TX)</option>
              <option value="UT">Utah (UT)</option>
              <option value="VT">Vermont (VT)</option>
              <option value="VA">Virginia (VA)</option>
              <option value="WA">Washington (WA)</option>
              <option value="WV">West Virginia (WV)</option>
              <option value="WI">Wisconsin (WI)</option>
              <option value="WY">Wyoming (WY)</option>
              <!-- Canada -->
              <option value="AB">Alberta (AB)</option>
              <option value="BC">British Columbia (BC)</option>
              <option value="MB">Manitoba (MB)</option>
              <option value="NB">New Brunswick (NB)</option>
              <option value="NL">Newfoundland and Labrador (NL)</option>
              <option value="NS">Nova Scotia (NS)</option>
              <option value="NT">Northwest Territories (NT)</option>
              <option value="NU">Nunavut (NU)</option>
              <option value="ON">Ontario (ON)</option>
              <option value="PE">Prince Edward Island (PE)</option>
              <option value="QC">Quebec (QC)</option>
              <option value="SK">Saskatchewan (SK)</option>
              <option value="YT">Yukon (YT)</option>
            </select>
          </div>
          <div>
            <label for="signupZip">ZIP / Postal</label><br>
            <input id="signupZip" type="text" maxlength="12" autocomplete="off" placeholder="25951">
          </div>
        </div>

        <div style="margin-bottom:8px;margin-top:10px;">
          <label for="signupCode" style="font-size:14px;">Your 4-digit code (you choose it):</label><br>
          <input id="signupCode" type="text" maxlength="8" autocomplete="off" inputmode="numeric"
                 placeholder="1234" style="width:160px;text-align:center;">
        </div>

        <div style="margin-bottom:8px;">
          <label for="signupPay" style="font-size:14px;">Deposit payment method:</label><br>
          <select id="signupPay">
            <option value="">-- Select --</option>
            <option value="PayPal">PayPal</option>
            <option value="Cash App">Cash App</option>
            <option value="Venmo">Venmo</option>
          </select>
        </div>

        <div style="text-align:center;">
          <button type="submit">‚úÖ Submit Sign Up</button>
        </div>
      </form>

      <div id="signupStatus" class="status"></div>

      <!-- Mark deposit sent -->
      <div style="margin-top:18px;border-top:1px solid #333;padding-top:10px;">
        <h3 style="margin:0 0 6px 0;font-size:15px;">Already signed up?</h3>
        <p class="small-note" style="margin-top:2px;">
          Enter the same 4-digit code you used to mark that you have sent your deposit.
        </p>
        <div class="code-row">
          <label for="depositCodeInput">Your code:</label>
          <input id="depositCodeInput" type="text" maxlength="8" autocomplete="off" inputmode="numeric"
                 placeholder="1234" style="width:160px;">
          <button id="markDepositBtn" class="btn-secondary">üí∞ Mark Deposit Sent</button>
        </div>
        <div id="depositStatus" class="status"></div>
      </div>
    </div>
  </div>

  <!-- Public list card -->
  <div class="card">
    <h2 style="margin-top:0;">2. Sign-Up List</h2>
    <p class="admin-small-note">
    </p>
    <table class="list-table" id="publicTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>State</th>
          <th>Payment Method</th>
          <th>Deposit (User)</th>
          <th>Deposit (Admin)</th>
        </tr>
      </thead>
      <tbody id="publicTableBody">
      </tbody>
    </table>
  </div>

  <!-- Admin section -->
  <div class="card">
    <div class="admin-header">
      <h2>Organizer(Admin)</h2>
      <button id="toggleAdminBtn" class="btn-secondary" style="margin-top:0;">Hide Admin Panel</button>
    </div>

    <!-- Locked view -->
    <div id="adminLocked" style="margin-top:12px; display:block;">
      <div class="code-row" style="justify-content:flex-start;">
        <label for="adminCodeInput" style="font-size:13px;">Admin code:</label>
        <input id="adminCodeInput" type="password" maxlength="16" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
               autocomplete="new-password">
        <button id="adminUnlockBtn">Unlock</button>
      </div>
      <div id="adminLockStatus" class="status" style="text-align:left;"></div>
      <div class="admin-small-note">
        This area is for the organizer only.
      </div>
    </div>

    <!-- Unlocked admin tools -->
    <div id="adminUnlocked" style="display:none;margin-top:14px;">
      <h3 style="margin:0 0 6px 0;font-size:15px;">Sign-Ups (Admin View)</h3>
      <p class="admin-small-note">
        Click ‚ÄúApproved‚Äù to mark deposits as verified.<br>

      <table class="list-table" id="adminTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Address</th>
            <th>State</th>
            <th>Code</th>
            <th>Pay Method</th>
            <th>User Marked?</th>
            <th>Admin Approved?</th>
            <th>Tracking #</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminTableBody">
        </tbody>
      </table>

      <!-- Assignments preview -->
      <h3 style="margin:16px 0 6px 0;font-size:15px;">Assignments Preview (Approved Only)</h3>
      <p class="admin-small-note">
        Preview Assignments: to generate assignments click matches you don't like and re generate until your satisfied
        <strong>approved</strong> 
        <br>
        Commit Assignments: sends the assignments to the reveal portion and starts the exchange 
      </p>

      <div style="margin-bottom:8px;">
        <button id="generatePreviewBtn" class="btn-secondary">üé≤ Preview Assignments</button>
        <button id="commitAssignmentsBtn" class="btn-secondary">‚úÖ Commit Assigments</button>
      </div>

      <table class="list-table" id="previewTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Sender</th>
            <th></th>
            <th>Receiver</th>
          </tr>
        </thead>
        <tbody id="previewTableBody">
        </tbody>
      </table>

      <div style="margin-top:10px;">
        <button id="clearAllBtn" class="btn-danger">üóë Clear All Sign-Ups & Reset</button>
      </div>

      <div id="adminStatus" class="status" style="text-align:left;"></div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// ===== 1. Firebase config ‚Äì your project =====
const firebaseConfig = {
  apiKey: "AIzaSyDVlyLssFBefRTRWMNFtNJG7uKNKsWEqDA",
  authDomain: "rock-exchange.firebaseapp.com",
  projectId: "rock-exchange",
  storageBucket: "rock-exchange.firebasestorage.app",
  messagingSenderId: "916313020352",
  appId: "1:916313020352:web:48c363939a1b923a751a25",
  measurementId: "G-LS6C7PX4G4"
};
// =================================================================

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== CONFIG: Admin code for unlocking admin panel =====
const ADMIN_CODE = "Pink0209";  // change this to your secret
// ========================================================

function regionForState(st) {
  const up = (st || "").toUpperCase();
  const stateToRegion = {
    ME:"Northeast", NH:"Northeast", VT:"Northeast", MA:"Northeast",
    RI:"Northeast", CT:"Northeast", NY:"Northeast", NJ:"Northeast",
    PA:"Northeast",

    OH:"Midwest", MI:"Midwest", IN:"Midwest", IL:"Midwest",
    WI:"Midwest", MN:"Midwest", IA:"Midwest", MO:"Midwest",
    ND:"Midwest", SD:"Midwest", NE:"Midwest", KS:"Midwest",

    DE:"South", MD:"South", DC:"South", VA:"South", WV:"South",
    NC:"South", SC:"South", GA:"South", FL:"South",
    KY:"South", TN:"South", AL:"South", MS:"South",
    AR:"South", LA:"South", OK:"South", TX:"South",

    MT:"Mountain", ID:"Mountain", WY:"Mountain", CO:"Mountain",
    NM:"Mountain", AZ:"Mountain", UT:"Mountain", NV:"Mountain",

    WA:"West", OR:"West", CA:"West",

    AK:"Alaska", HI:"Hawaii"
  };
  return stateToRegion[up] || "Unknown";
}

// ===== Name + Address formatting helpers =====
function titleCaseWord(word) {
  if (!word) return "";
  return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
}

function formatName(name) {
  if (!name) return "";
  return name
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim()
    .split(" ")
    .map(w => titleCaseWord(w))
    .join(" ");
}

function formatCity(city) {
  if (!city) return "";
  return city
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim()
    .split(" ")
    .map(w => titleCaseWord(w))
    .join(" ");
}

function formatStreet(street) {
  if (!street) return "";
  let cleaned = street.replace(/\s+/g, " ").trim();
  if (!cleaned) return "";

  const suffixMap = {
    "st": "St.",
    "street": "St.",
    "rd": "Rd.",
    "road": "Rd.",
    "ave": "Ave.",
    "avenue": "Ave.",
    "blvd": "Blvd.",
    "boulevard": "Blvd.",
    "ln": "Ln.",
    "lane": "Ln.",
    "dr": "Dr.",
    "drive": "Dr.",
    "ct": "Ct.",
    "court": "Ct.",
    "pkwy": "Pkwy.",
    "parkway": "Pkwy.",
    "pl": "Pl.",
    "place": "Pl."
  };

  const dirMap = {
    "n": "N",
    "s": "S",
    "e": "E",
    "w": "W",
    "ne": "NE",
    "nw": "NW",
    "se": "SE",
    "sw": "SW"
  };

  const parts = cleaned.split(" ");
  const out = parts.map(part => {
    let raw = part;
    let trailing = "";

    // handle trailing punctuation like "," or "."
    if (/[.,]$/.test(raw)) {
      trailing = raw.slice(-1);
      raw = raw.slice(0, -1);
    }

    const lower = raw.toLowerCase();

    if (dirMap[lower]) {
      return dirMap[lower] + trailing;
    }

    if (suffixMap[lower]) {
      return suffixMap[lower] + trailing;
    }

    // If it's something with a digit (apt numbers, etc.) keep as-is (plus trailing)
    if (/\d/.test(raw)) {
      return raw + trailing;
    }

    // Default: title case the word
    return titleCaseWord(raw) + trailing;
  });

  return out.join(" ");
}

// ========== UI elements for reveal vs signup ==========

const revealSection = document.getElementById("revealSection");
const signupSection = document.getElementById("signupSection");

db.collection("settings").doc("global").onSnapshot((snap) => {
  let revealEnabled = false;
  if (snap.exists) {
    const d = snap.data();
    revealEnabled = !!d.revealEnabled;
  }
  if (revealEnabled) {
    revealSection.style.display = "block";
    signupSection.style.display = "none";
  } else {
    revealSection.style.display = "none";
    signupSection.style.display = "block";
  }
}, (err) => {
  console.error("settings/global listener error:", err);
});

// ========== SIGN-UP LOGIC ==========

const showSignupBtn = document.getElementById("showSignupBtn");
const signupForm = document.getElementById("signupForm");
const signupStatus = document.getElementById("signupStatus");

showSignupBtn.addEventListener("click", () => {
  signupForm.style.display = "block";
  showSignupBtn.style.display = "none";
});

signupForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  signupStatus.textContent = "";
  signupStatus.className = "status";

  let name = document.getElementById("signupName").value.trim();
  let street = document.getElementById("signupStreet").value.trim();
  let city = document.getElementById("signupCity").value.trim();
  const stateCode = document.getElementById("signupState").value.trim();
  const zip = document.getElementById("signupZip").value.trim();
  const code = document.getElementById("signupCode").value.trim();
  const payment = document.getElementById("signupPay").value;

  if (!name || !street || !city || !stateCode || !zip || !code || !payment) {
    signupStatus.textContent = "Please fill in all fields (name, full address, code, payment method).";
    signupStatus.classList.add("error");
    return;
  }

  // Normalize/format name + address for display/storage
  name = formatName(name);
  street = formatStreet(street);
  city = formatCity(city);

  const addressFull = `${street}, ${city}, ${stateCode} ${zip}`;

  try {
    await db.collection("signups").add({
      name,
      addressStreet: street,
      addressCity: city,
      addressStateCode: stateCode,
      addressZip: zip,
      addressFull,
      state: stateCode,
      code,
      paymentMethod: payment,
      depositSent: false,
      depositApproved: false,
      trackingNumber: "",
      trackingSubmitted: false,
      trackingSubmittedAt: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      assignedToId: null,
      assignedToName: null,
      assignedToAddressFull: null,
      assignedToState: null,
      assignedAt: null
    });

    signupStatus.innerHTML = `
    üéâ <strong>Signup complete!</strong><br>
    Please send your deposit using one of the methods below.<br>
    After sending, use your 4-digit code to mark deposit as sent.
    <div style="margin-top:10px;">
        <button class="btn-secondary" onclick="openPayment('PayPal')">Pay with PayPal</button>
        <button class="btn-secondary" onclick="openPayment('CashApp')">Pay with Cash App</button>
        <button class="btn-secondary" onclick="openPayment('Venmo')">Pay with Venmo</button>
    </div>
    `;
    signupStatus.classList.add("success");

    signupForm.reset();
    signupForm.style.display = "none";
    showSignupBtn.style.display = "inline-block";
  } catch (err) {
    console.error(err);
    signupStatus.textContent = "Error saving sign-up. Please try again or contact the organizer.";
    signupStatus.classList.add("error");
  }
});

// ========== MARK DEPOSIT SENT (BY USER CODE) ==========

const depositCodeInput = document.getElementById("depositCodeInput");
const markDepositBtn = document.getElementById("markDepositBtn");
const depositStatus = document.getElementById("depositStatus");

markDepositBtn.addEventListener("click", async () => {
  depositStatus.textContent = "";
  depositStatus.className = "status";
  const code = depositCodeInput.value.trim();

  if (!code) {
    depositStatus.textContent = "Please enter your code.";
    depositStatus.classList.add("error");
    return;
  }

  try {
    const snap = await db.collection("signups")
      .where("code", "==", code)
      .limit(1)
      .get();

    if (snap.empty) {
      depositStatus.textContent = "No sign-up found with that code. Double-check or contact the organizer.";
      depositStatus.classList.add("error");
      return;
    }

    const doc = snap.docs[0];
    await doc.ref.update({ depositSent: true });

    depositStatus.textContent = "Marked your deposit as sent. Thank you!";
    depositStatus.classList.add("success");
  } catch (err) {
    console.error(err);
    depositStatus.textContent = "Error updating deposit status. Please try again.";
    depositStatus.classList.add("error");
  }
});

// ========== REVEAL MATCH + TRACKING (after assignments generated) ==========

const revealCodeInput = document.getElementById("revealCodeInput");
const revealBtn = document.getElementById("revealBtn");
const revealStatus = document.getElementById("revealStatus");
const revealResultCard = document.getElementById("revealResultCard");
const trackingSection = document.getElementById("trackingSection");
const trackingInput = document.getElementById("trackingInput");
const submitTrackingBtn = document.getElementById("submitTrackingBtn");
const trackingStatus = document.getElementById("trackingStatus");
const incomingTrackingDisplay = document.getElementById("incomingTrackingDisplay");

let currentRevealDocId = null;

async function loadIncomingTracking(myDocId) {
  incomingTrackingDisplay.textContent = "";
  try {
    const snap = await db.collection("signups")
      .where("assignedToId", "==", myDocId)
      .limit(1)
      .get();

    if (snap.empty) {
      incomingTrackingDisplay.textContent =
        "Tracking number for the box coming to you: (not submitted yet)";
      return;
    }

    const d = snap.docs[0].data();
    if (d.trackingSubmitted && d.trackingNumber) {
      incomingTrackingDisplay.textContent =
        "Tracking number for the box coming to you: " + d.trackingNumber;
    } else {
      incomingTrackingDisplay.textContent =
        "Tracking number for the box coming to you: (not submitted yet)";
    }
  } catch (err) {
    console.error(err);
    incomingTrackingDisplay.textContent =
      "Unable to load tracking for your incoming package right now.";
  }
}

async function revealMatch() {
  revealStatus.textContent = "";
  revealStatus.className = "status";
  revealResultCard.style.display = "none";
  revealResultCard.textContent = "";
  trackingSection.style.display = "none";
  trackingStatus.textContent = "";
  trackingStatus.className = "status";
  incomingTrackingDisplay.textContent = "";
  currentRevealDocId = null;

  const code = revealCodeInput.value.trim();
  if (!code) {
    revealStatus.textContent = "Please enter your code.";
    revealStatus.classList.add("error");
    return;
  }

  try {
    const settingsSnap = await db.collection("settings").doc("global").get();
    const revealEnabled = settingsSnap.exists && !!settingsSnap.data().revealEnabled;
    if (!revealEnabled) {
      revealStatus.textContent = "Assignments are not revealed yet. Please wait for the organizer to enable reveal.";
      revealStatus.classList.add("error");
      return;
    }

    const snap = await db.collection("signups")
      .where("code", "==", code)
      .limit(1)
      .get();

    if (snap.empty) {
      revealStatus.textContent = "No sign-up found with that code. Double-check or contact the organizer.";
      revealStatus.classList.add("error");
      return;
    }

    const doc = snap.docs[0];
    const d = doc.data();
    currentRevealDocId = doc.id;

    const toName = d.assignedToName;
    const toAddr = d.assignedToAddressFull || d.assignedToAddress || "";

    if (!toName || !toAddr) {
      revealStatus.textContent =
        "You are signed up, but assignments are not ready yet. Please contact the organizer.";
      revealStatus.classList.add("error");
      return;
    }

    revealStatus.textContent = "Match found!";
    revealStatus.classList.add("success");

    revealResultCard.innerHTML =
      `<div><strong>Hello ${d.name}!</strong></div>` +
      `<div style="margin-top:6px;">For this Rock Exchange, you'll be sending rocks to:</div>` +
      `<div style="margin-top:6px;padding-left:8px;"><strong>${toName}</strong><br>${toAddr}</div>` +
      `<div style="margin-top:10px;font-size:12px;color:#ccc;">` +
      `Please mail your box on or before Dec. 12. Submit a valid tracking number and I will refund your deposit.` +
      `</div>` +
      `<div style="margin-top:6px;font-size:12px;color:#ccc;">` +
      `Thank you for being part of this Exchange!` +
      `</div>`;

    revealResultCard.style.display = "block";
    revealResultCard.classList.remove("fade-in");
    void revealResultCard.offsetWidth;
    revealResultCard.classList.add("fade-in");

    // Show tracking section & prefill if exists
    trackingInput.value = d.trackingNumber || "";
    trackingSection.style.display = "block";

    // Load tracking for incoming package
    await loadIncomingTracking(doc.id);
  } catch (err) {
    console.error(err);
    revealStatus.textContent = "Error looking up your assignment. Please try again.";
    revealStatus.classList.add("error");
  }
}

revealBtn.addEventListener("click", revealMatch);
revealCodeInput.addEventListener("keyup", (e) => {
  if (e.key === "Enter") revealMatch();
});

// Submit tracking (for the box they are sending)
submitTrackingBtn.addEventListener("click", async () => {
  trackingStatus.textContent = "";
  trackingStatus.className = "status";

  if (!currentRevealDocId) {
    trackingStatus.textContent = "Please reveal your match first.";
    trackingStatus.classList.add("error");
    return;
  }

  const trackingNumber = trackingInput.value.trim();
  if (!trackingNumber) {
    trackingStatus.textContent = "Please enter a tracking number.";
    trackingStatus.classList.add("error");
    return;
  }

  try {
    await db.collection("signups").doc(currentRevealDocId).update({
      trackingNumber,
      trackingSubmitted: true,
      trackingSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    trackingStatus.textContent = "Tracking number submitted. Thank you!";
    trackingStatus.classList.add("success");

    // Also refresh incoming tracking display in case this user is also someone's recipient
    await loadIncomingTracking(currentRevealDocId);
  } catch (err) {
    console.error(err);
    trackingStatus.textContent = "Error saving tracking number. Please try again.";
    trackingStatus.classList.add("error");
  }
});

// ========== REAL-TIME LISTENERS FOR PUBLIC + ADMIN TABLES ==========

const publicTableBody = document.getElementById("publicTableBody");
const adminTableBody = document.getElementById("adminTableBody");
const adminStatus = document.getElementById("adminStatus");

db.collection("signups")
  .orderBy("createdAt", "asc")
  .onSnapshot((snapshot) => {
    const rowsPublic = [];
    const rowsAdmin = [];
    let idx = 0;

    snapshot.forEach(doc => {
      idx++;
      const d = doc.data();

      const name = d.name || "";
      const stateDisplay = d.addressStateCode || d.state || "";
      const pm = d.paymentMethod || "";
      const depositSent = !!d.depositSent;
      const depositApproved = !!d.depositApproved;
      const trackingSubmitted = !!d.trackingSubmitted;
      const trackingNumber = d.trackingNumber || "";
      const addressFull = d.addressFull || d.address || "";
      const code = d.code || "";

      // Public row
      const trPub = document.createElement("tr");
      trPub.innerHTML = `
        <td>${idx}</td>
        <td>${name}</td>
        <td>${stateDisplay}</td>
        <td>${pm || "‚Äî"}</td>
        <td>
          <span class="badge ${depositSent ? "badge-sent" : "badge-not-sent"}">
            ${depositSent ? "Sent" : "Not Sent"}
          </span>
        </td>
        <td>
          <span class="badge ${depositApproved ? "badge-approved" : "badge-not-approved"}">
            ${depositApproved ? "Approved" : "Pending"}
          </span>
        </td>
      `;
      rowsPublic.push(trPub);

      // Admin row
      const trAdmin = document.createElement("tr");
      trAdmin.setAttribute("data-id", doc.id);
      trAdmin.innerHTML = `
        <td>${idx}</td>
        <td>${name}</td>
        <td style="max-width:260px;white-space:normal;">${addressFull}</td>
        <td>${stateDisplay}</td>
        <td>${code || "‚Äî"}</td>
        <td>${pm || "‚Äî"}</td>
        <td>
          <span class="badge ${depositSent ? "badge-sent" : "badge-not-sent"}">
            ${depositSent ? "Sent" : "Not Sent"}
          </span>
        </td>
        <td>
          <span class="badge clickable ${depositApproved ? "badge-approved" : "badge-not-approved"}">
            ${depositApproved ? "Approved" : "Click to Approve"}
          </span>
        </td>
        <td>${trackingNumber ? trackingNumber : "‚Äî"}</td>
        <td>
          <button class="btn-small btn-danger btn-delete">Delete</button>
        </td>
      `;
      rowsAdmin.push(trAdmin);
    });

    publicTableBody.innerHTML = "";
    rowsPublic.forEach(r => publicTableBody.appendChild(r));

    adminTableBody.innerHTML = "";
    rowsAdmin.forEach(r => adminTableBody.appendChild(r));

    attachAdminRowHandlers();
  }, (err) => {
    console.error("Error listening to signups:", err);
  });

// ========== ADMIN PANEL LOCK/UNLOCK ==========

const toggleAdminBtn = document.getElementById("toggleAdminBtn");
const adminLocked = document.getElementById("adminLocked");
const adminUnlocked = document.getElementById("adminUnlocked");
const adminCodeInput = document.getElementById("adminCodeInput");
const adminUnlockBtn = document.getElementById("adminUnlockBtn");
const adminLockStatus = document.getElementById("adminLockStatus");

// Show/hide admin card content
toggleAdminBtn.addEventListener("click", () => {
  const hidden = adminLocked.style.display === "none" && adminUnlocked.style.display === "none";
  if (hidden) {
    adminLocked.style.display = "block";
    toggleAdminBtn.textContent = "Hide Admin Panel";
  } else {
    adminLocked.style.display = "none";
    adminUnlocked.style.display = "none";
    toggleAdminBtn.textContent = "Show Admin Panel";
  }
});

// Initially show locked admin
adminLocked.style.display = "block";
adminUnlocked.style.display = "none";
toggleAdminBtn.textContent = "Hide Admin Panel";

adminUnlockBtn.addEventListener("click", () => {
  const entered = adminCodeInput.value.trim();
  adminLockStatus.textContent = "";
  adminLockStatus.className = "status";

  if (!entered) {
    adminLockStatus.textContent = "Please enter the admin code.";
    adminLockStatus.classList.add("error");
    return;
  }

  if (entered !== ADMIN_CODE) {
    adminLockStatus.textContent = "Incorrect admin code.";
    adminLockStatus.classList.add("error");
    return;
  }

  adminLockStatus.textContent = "Admin unlocked.";
  adminLockStatus.classList.add("success");

  adminLocked.style.display = "none";
  adminUnlocked.style.display = "block";
});

// ========== ADMIN: APPROVE & DELETE HANDLERS ==========

function attachAdminRowHandlers() {
  const rows = Array.from(adminTableBody.querySelectorAll("tr"));
  rows.forEach(row => {
    const docId = row.getAttribute("data-id");
    if (!docId) return;

    // Approve badge
    const approveBadge = row.querySelector("td:nth-child(8) .badge");
    if (approveBadge) {
      approveBadge.addEventListener("click", async () => {
        const alreadyApproved = approveBadge.classList.contains("badge-approved");
        if (alreadyApproved) return;

        try {
          await db.collection("signups").doc(docId).update({
            depositApproved: true
          });
          adminStatus.textContent = "Deposit approved.";
          adminStatus.className = "status success";
        } catch (err) {
          console.error(err);
          adminStatus.textContent = "Error approving deposit.";
          adminStatus.className = "status error";
        }
      });
    }

    // Delete button
    const deleteBtn = row.querySelector(".btn-delete");
    if (deleteBtn) {
      deleteBtn.addEventListener("click", async () => {
        const confirmed = confirm("Delete this sign-up? This cannot be undone.");
        if (!confirmed) return;

        try {
          await db.collection("signups").doc(docId).delete();
          adminStatus.textContent = "Sign-up deleted.";
          adminStatus.className = "status success";
        } catch (err) {
          console.error(err);
          adminStatus.textContent = "Error deleting sign-up.";
          adminStatus.className = "status error";
        }
      });
    }
  });
}

// ========== ASSIGNMENTS PREVIEW (ADMIN) ==========

const generatePreviewBtn = document.getElementById("generatePreviewBtn");
const commitAssignmentsBtn = document.getElementById("commitAssignmentsBtn");
const previewTableBody = document.getElementById("previewTableBody");

let previewParticipants = null;   // { id, name, addressFull, stateCode, region }
let previewAssignments = null;    // [{ fromIndex, toIndex }]
let selectedPreviewFromIndices = new Set();

// Simple shuffle helper
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// Generate full assignments (one-way, avoid self, regions, 2-cycles)
function generateAssignments(participants) {
  const n = participants.length;
  if (n < 2) return null;

  const idxs = [...Array(n).keys()];
  let bestPerm = null;
  let bestScore = Infinity;
  const maxTries = 500;

  function score(perm) {
    let selfSend = 0;
    let regionConf = 0;
    let twoCycles = 0;

    for (let i = 0; i < n; i++) {
      const j = perm[i];
      if (i === j) selfSend++;
      const a = participants[i];
      const b = participants[j];
      if (a.region !== "Unknown" && b.region !== "Unknown" && a.region === b.region) {
        regionConf++;
      }
    }

    for (let i = 0; i < n; i++) {
      const j = perm[i];
      if (j > i && perm[j] === i) {
        twoCycles++;
      }
    }

    return selfSend * 10000 + twoCycles * 100 + regionConf;
  }

  for (let attempt = 0; attempt < maxTries; attempt++) {
    shuffle(idxs);
    const perm = idxs.slice();
    const s = score(perm);
    if (s < bestScore) {
      bestScore = s;
      bestPerm = perm.slice();
      if (s === 0) break;
    }
  }

  if (!bestPerm) return null;

  // Final safety: fix any self-sends
  for (let i = 0; i < n; i++) {
    if (bestPerm[i] === i) {
      let swapWith = -1;
      for (let j = 0; j < n; j++) {
        if (j === i) continue;
        if (bestPerm[j] === j) continue;
        if (bestPerm[j] === i) continue;
        swapWith = j;
        break;
      }
      if (swapWith === -1) {
        const j = (i + 1) % n;
        [bestPerm[i], bestPerm[j]] = [bestPerm[j], bestPerm[i]];
      } else {
        [bestPerm[i], bestPerm[swapWith]] = [bestPerm[swapWith], bestPerm[i]];
      }
    }
  }

  const assignments = [];
  for (let i = 0; i < n; i++) {
    assignments.push({ fromIndex: i, toIndex: bestPerm[i] });
  }
  return assignments;
}

// Re-roll only a subset of senders, keeping others fixed
function rerollSubsetAssignments(participants, assignments, selectedFromIdxArr) {
  const n = participants.length;
  if (selectedFromIdxArr.length < 2) return false;

  const dest = new Array(n);
  for (let i = 0; i < n; i++) {
    dest[i] = assignments[i].toIndex;
  }

  const S = selectedFromIdxArr;
  const m = S.length;
  const pool = S.map(i => dest[i]);

  const maxTries = 400;
  let bestMap = null;
  let bestScore = Infinity;

  function scoreMapping(perm) {
    const tempDest = dest.slice();
    for (let k = 0; k < m; k++) {
      const fromIdx = S[k];
      const toIdx = pool[perm[k]];
      tempDest[fromIdx] = toIdx;
    }

    let selfSend = 0;
    let regionConf = 0;
    let twoCycles = 0;

    for (let i = 0; i < n; i++) {
      const j = tempDest[i];
      if (i === j) selfSend++;
      const a = participants[i];
      const b = participants[j];
      if (a.region !== "Unknown" && b.region !== "Unknown" && a.region === b.region) {
        regionConf++;
      }
    }

    for (let i = 0; i < n; i++) {
      const j = tempDest[i];
      if (j > i && tempDest[j] === i) {
        twoCycles++;
      }
    }

    return selfSend * 10000 + twoCycles * 100 + regionConf;
  }

  for (let attempt = 0; attempt < maxTries; attempt++) {
    const perm = [...Array(m).keys()];
    shuffle(perm);

    // quick self-send check
    let bad = false;
    for (let k = 0; k < m; k++) {
      const fromIdx = S[k];
      const toIdx = pool[perm[k]];
      if (toIdx === fromIdx) {
        bad = true;
        break;
      }
    }
    if (bad) continue;

    const sc = scoreMapping(perm);
    if (sc < bestScore) {
      bestScore = sc;
      bestMap = perm.slice();
      if (sc === 0) break;
    }
  }

  if (!bestMap) return false;

  for (let k = 0; k < m; k++) {
    const fromIdx = S[k];
    const toIdx = pool[bestMap[k]];
    dest[fromIdx] = toIdx;
  }

  for (let i = 0; i < n; i++) {
    assignments[i].toIndex = dest[i];
  }

  return true;
}

// Render preview table: separate Sender / arrow / Receiver columns
function renderPreviewTable(participants, assignments) {
  previewTableBody.innerHTML = "";
  selectedPreviewFromIndices.clear();

  assignments.forEach((a, idx) => {
    const from = participants[a.fromIndex];
    const to = participants[a.toIndex];

    const tr = document.createElement("tr");
    tr.className = "preview-row";
    tr.setAttribute("data-from-index", String(a.fromIndex));
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${from.name} (${from.stateCode})</td>
      <td style="text-align:center;">‚Üí</td>
      <td>${to.name} (${to.stateCode})</td>
    `;
    previewTableBody.appendChild(tr);
  });

  attachPreviewRowHandlers();
}

function attachPreviewRowHandlers() {
  const rows = Array.from(previewTableBody.querySelectorAll("tr.preview-row"));
  rows.forEach(row => {
    row.addEventListener("click", () => {
      const fromIdx = parseInt(row.getAttribute("data-from-index"), 10);
      if (selectedPreviewFromIndices.has(fromIdx)) {
        selectedPreviewFromIndices.delete(fromIdx);
        row.classList.remove("preview-row-selected");
      } else {
        selectedPreviewFromIndices.add(fromIdx);
        row.classList.add("preview-row-selected");
      }
    });
  });
}

// Helper to compare participant ID sets
function sameParticipantSet(oldList, newList) {
  if (!oldList) return false;
  if (oldList.length !== newList.length) return false;
  const oldIds = oldList.map(p => p.id).sort();
  const newIds = newList.map(p => p.id).sort();
  for (let i = 0; i < oldIds.length; i++) {
    if (oldIds[i] !== newIds[i]) return false;
  }
  return true;
}

generatePreviewBtn.addEventListener("click", async () => {
  adminStatus.textContent = "";
  adminStatus.className = "status";

  try {
    // Always fetch current approved participants
    const snap = await db.collection("signups")
      .where("depositApproved", "==", true)
      .get();

    if (snap.size < 2) {
      adminStatus.textContent = "Need at least 2 approved participants to generate assignments.";
      adminStatus.classList.add("error");
      previewTableBody.innerHTML = "";
      previewParticipants = null;
      previewAssignments = null;
      selectedPreviewFromIndices.clear();
      return;
    }

    const participantsNow = [];
    snap.forEach(doc => {
      const d = doc.data();
      const stateCode = d.addressStateCode || d.state || "";
      participantsNow.push({
        id: doc.id,
        name: d.name || "",
        addressFull: d.addressFull || d.address || "",
        stateCode,
        region: regionForState(stateCode),
        code: d.code || ""
      });
    });

    // If we have no preview yet, or participants changed (new/removed), rebuild fully
    if (!previewParticipants || !previewAssignments || !sameParticipantSet(previewParticipants, participantsNow)) {
      const assignments = generateAssignments(participantsNow);
      if (!assignments) {
        adminStatus.textContent = "Could not generate assignments. Try again.";
        adminStatus.classList.add("error");
        previewTableBody.innerHTML = "";
        previewParticipants = null;
        previewAssignments = null;
        selectedPreviewFromIndices.clear();
        return;
      }

      previewParticipants = participantsNow;
      previewAssignments = assignments;
      renderPreviewTable(previewParticipants, previewAssignments);

      adminStatus.textContent =
        "Preview assignments generated from current approved list. Click rows to highlight, then re-roll or commit.";
      adminStatus.classList.add("success");
      return;
    }

    // Participants are the same set as before; use re-roll logic with current preview
    previewParticipants = participantsNow; // keep up-to-date reference
    const selected = Array.from(selectedPreviewFromIndices);

    if (selected.length === 0) {
      // Re-roll entire list
      const assignments = generateAssignments(previewParticipants);
      if (!assignments) {
        adminStatus.textContent = "Could not re-roll assignments. Try again.";
        adminStatus.classList.add("error");
        return;
      }
      previewAssignments = assignments;
      renderPreviewTable(previewParticipants, previewAssignments);
      adminStatus.textContent = "Entire preview re-rolled.";
      adminStatus.classList.add("success");
    } else if (selected.length === 1) {
      adminStatus.textContent =
        "Select at least 2 rows to re-roll subset; a single assignment can't be changed alone because all matches are connected.";
      adminStatus.classList.add("error");
    } else {
      const ok = rerollSubsetAssignments(previewParticipants, previewAssignments, selected);
      if (!ok) {
        adminStatus.textContent =
          "Could not find a better subset re-roll with current constraints. Try selecting a different group or re-rolling all.";
        adminStatus.classList.add("error");
        return;
      }
      renderPreviewTable(previewParticipants, previewAssignments);
      adminStatus.textContent = "Selected preview rows re-rolled.";
      adminStatus.classList.add("success");
    }
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error generating preview assignments. Please try again.";
    adminStatus.classList.add("error");
  }
});

commitAssignmentsBtn.addEventListener("click", async () => {
  adminStatus.textContent = "";
  adminStatus.className = "status";

  if (!previewParticipants || !previewAssignments) {
    adminStatus.textContent = "No preview assignments to commit. Generate a preview first.";
    adminStatus.classList.add("error");
    return;
  }

  const confirmed = confirm(
    "This will save the current preview assignments for all approved participants and enable the reveal page.\n" +
    "Sign-ups will effectively be closed. Continue?"
  );
  if (!confirmed) return;

  try {
    const batch = db.batch();

    previewAssignments.forEach(a => {
      const from = previewParticipants[a.fromIndex];
      const to = previewParticipants[a.toIndex];
      const ref = db.collection("signups").doc(from.id);
      batch.update(ref, {
        assignedToId: to.id,
        assignedToName: to.name,
        assignedToAddressFull: to.addressFull,
        assignedToState: to.stateCode,
        assignedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    const settingsRef = db.collection("settings").doc("global");
    batch.set(settingsRef, {
      revealEnabled: true,
      lastAssignmentsAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    await batch.commit();

    adminStatus.textContent = "Assignments committed and reveal has been enabled. Participants can now use their codes.";
    adminStatus.classList.add("success");
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error committing assignments. Please try again.";
    adminStatus.classList.add("error");
  }
});

// ========== CLEAR ALL SIGN-UPS & RESET (ADMIN) ==========

const clearAllBtn = document.getElementById("clearAllBtn");

clearAllBtn.addEventListener("click", async () => {
  adminStatus.textContent = "";
  adminStatus.className = "status";

  const confirmed = confirm(
    "This will delete ALL sign-ups and reset reveal settings.\n" +
    "Only do this if you want to completely reset the swap.\n\n" +
    "Are you sure?"
  );
  if (!confirmed) return;

  try {
    const snap = await db.collection("signups").get();
    const batch = db.batch();

    snap.forEach(doc => {
      batch.delete(doc.ref);
    });

    const settingsRef = db.collection("settings").doc("global");
    batch.set(settingsRef, {
      revealEnabled: false,
      lastAssignmentsAt: null
    }, { merge: true });

    await batch.commit();

    previewTableBody.innerHTML = "";
    previewParticipants = null;
    previewAssignments = null;
    selectedPreviewFromIndices.clear();

    adminStatus.textContent = "All sign-ups cleared and swap reset.";
    adminStatus.classList.add("success");
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error clearing sign-ups. Please try again.";
    adminStatus.classList.add("error");
  }
});

function openPayment(method) {
    const links = {
        PayPal: "https://paypal.me/donnapevey1",         // replace w/ real link
        CashApp: "https://cash.app/$donnapevey",        // replace w/ real cashtag
        Venmo: "https://venmo.com/u/Donnapevey00"       // replace w/ real link
    };

    const url = links[method];
    if (url) {
        window.open(url, "_blank", "noopener,noreferrer");
    }
}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rockhounding For Beginners - The Original - Rock Exchange</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #151a22;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 6px;
    }

    p.subtitle {
      text-align: center;
      font-size: 12px;
      color: #bbbbbb;
      margin-top: 0;
      margin-bottom: 20px;
    }

    .card {
      background: #202837;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      margin-bottom: 18px;
    }

    .code-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }

    .code-row label {
      font-size: 14px;
    }

    input[type="text"], input[type="password"], select {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #0f1420;
      color: #f5f5f5;
      box-shadow: inset 0 0 0 1px #333;
      font-size: 15px;
    }

    input[type="text"], input[type="password"] {
      letter-spacing: 1px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      resize: vertical;
      font-family: monospace;
      font-size: 13px;
      background: #0f1420;
      color: #f5f5f5;
      box-shadow: inset 0 0 0 1px #333;
    }

    button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    button:hover {
      background: #5ec660;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary { background: #3f51b5; }
    .btn-danger { background: #c62828; }

    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      margin-top: 0;
      margin-right: 4px;
    }

    .status {
      margin-top: 10px;
      min-height: 18px;
      font-size: 13px;
      text-align: center;
    }

    .status.error { color: #ff8a80; }
    .status.success { color: #9cff9c; }

    .result-card {
      margin-top: 14px;
      background: #181f2c;
      border-radius: 10px;
      padding: 14px;
      box-shadow: inset 0 0 0 1px #333;
      font-size: 14px;
      line-height: 1.4;
    }

    .result-card strong { color: #ffd54f; }

    .small-note {
      font-size: 11px;
      color: #bbb;
      margin-top: 10px;
      text-align: center;
    }

    .fade-in { animation: fadeIn 0.4s ease forwards; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .admin-header h2 {
      border-bottom: none;
      margin: 0;
      padding: 0;
      font-size: 18px;
    }

    .admin-small-note {
      font-size: 11px;
      color: #aaa;
      margin-top: 6px;
      text-align: left;
    }

    .list-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    .list-table th, .list-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #333;
      text-align: left;
      vertical-align: top;
    }

    .list-table th {
      background: #1a2231;
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
    }

    .badge-approved { background: #66bb6a; color: #000; }
    .badge-not-approved { background: #b0bec5; color: #000; }
    .clickable { cursor: pointer; }

    .address-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-top: 8px;
    }

    .address-grid label { font-size: 13px; }

    .address-grid input, .address-grid select {
      width: 100%;
      text-align: left;
      letter-spacing: 0;
    }

    .preview-row-selected { background: #334155 !important; }

    /* ===== Mobile + Modern Patch ===== */
    input[type="text"], input[type="password"], select, textarea, button { font-size: 16px; }
    button { min-height: 44px; }
    body { display: block; align-items: initial; }
    .container { margin: 0 auto; padding: 16px; }
    .card { margin-bottom: 14px; padding: 16px; }

    @media (max-width: 720px) {
      .address-grid { grid-template-columns: 1fr; }
      .code-row { justify-content: stretch; }
      .code-row input, .code-row select, .code-row button { width: 100%; }
      .list-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    * { box-sizing: border-box; }
    input, select, textarea, button { max-width: 100%; }

    .address-grid { gap: 12px 14px; }
    .address-grid > div, .address-grid label, .address-grid input, .address-grid select { min-width: 0; }
    .address-grid label { display: block; margin-bottom: 6px; }

    #signupForm { width: 100%; }
    #signupForm > div { margin-bottom: 12px !important; }

    #signupForm label, .address-grid label {
      display: block;
      margin: 0 0 6px !important;
      line-height: 1.2;
    }

    #signupForm input, #signupForm select, #signupForm textarea,
    .address-grid input, .address-grid select {
      display: block;
      width: 100%;
      max-width: 100%;
    }

    #signupForm br, .address-grid br { display: none; }
    .address-grid > div { min-width: 0; }
    #signupCode { width: 160px !important; max-width: 100%; text-align: center; }

    /* ===== LIGHT THEME OVERRIDE ===== */
    body{ background:#f7f8fb; color:#1f2937; }
    h1{ color:#0f172a; font-weight:700; }
    p.subtitle{ color:#475569; }

    .card{
      background:#ffffff;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 12px 30px rgba(30, 41, 59, 0.12);
    }

    .small-note, .admin-small-note{ color:#475569; }

    input[type="text"], input[type="password"], select, textarea{
      background:#f9fafb;
      color:#111827;
      border-radius: 10px;
      box-shadow: inset 0 0 0 1px #cbd5e1;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    textarea{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    input:focus, select:focus, textarea:focus{
      outline:none;
      box-shadow:
        0 0 0 4px rgba(59,130,246,.15),
        inset 0 0 0 1px #3b82f6;
    }

    button{
      background:#2563eb;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.18);
    }

    button:hover{ background:#1d4ed8; }
    .btn-secondary{ background:#0f766e; }
    .btn-secondary:hover{ background:#115e59; }
    .btn-danger{ background:#dc2626; }
    .btn-danger:hover{ background:#b91c1c; }

    .status.error{ color:#b91c1c; }
    .status.success{ color:#166534; }

    .result-card{
      background:#f8fafc;
      box-shadow: inset 0 0 0 1px #dbe3ef;
    }

    .result-card strong{ color:#b45309; }

    .list-table th, .list-table td{ border-bottom: 1px solid #e5e7eb; }
    .list-table th{ background:#f1f5f9; }

    #publicTable td:nth-child(2) {
      word-break: normal !important;
      overflow-wrap: normal !important;
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      #publicTable td:nth-child(2) {
        white-space: normal;
        overflow-wrap: break-word;
      }
    }
  </style>
</head>

<body autocomplete="off">
<div class="container">
  <h1>Rockhounding For Beginners - The Original - Rock Exchange</h1>

  <!-- Card 1: Reveal OR Sign-up (toggled by settings) -->
  <div class="card">
    <!-- Reveal section -->
    <div id="revealSection" style="display:none;">
      <h2 style="margin-top:0;">1. Reveal Your Match</h2>
      <p class="small-note" style="margin-top:2px;">
        Enter the same 4-digit code you used when signing up to see who you are sending your rocks to.
      </p>
      <div class="code-row">
        <label for="revealCodeInput">Your code:</label>
        <input id="revealCodeInput" type="text" maxlength="8" autocomplete="off" inputmode="numeric"
               placeholder="1234" style="width:160px;">
        <button id="revealBtn" type="button">‚ú® Reveal My Match</button>
      </div>
      <div id="revealStatus" class="status"></div>
      <div id="revealResultCard" class="result-card" style="display:none;"></div>

      <!-- Tracking section -->
      <div id="trackingSection" style="display:none; margin-top:10px;">
        <p class="small-note">
          After you have mailed your box, enter your tracking number below so the organizer can confirm and refund your deposit.
        </p>
        <div class="code-row">
          <label for="trackingInput">Tracking #:</label>
          <input id="trackingInput" type="text" autocomplete="off"
                 placeholder="e.g. 9400 1234 5678 9000 0000 00" style="min-width:260px;">
          <button id="submitTrackingBtn" type="button" class="btn-secondary">üì¶ Submit Tracking</button>
        </div>
        <div id="trackingStatus" class="status"></div>
        <div id="incomingTrackingDisplay" class="small-note" style="margin-top:4px;"></div>
      </div>
    </div>

    <!-- Signup section -->
    <div id="signupSection">
      <h2 style="margin-top:0;">Sign Up</h2>
      <div id="signupIntro" style="text-align:center;margin-bottom:10px;">
        <button id="showSignupBtn" type="button">üìù Sign Up for This Exchange</button>
      </div>

      <form id="signupForm" style="display:none;max-width:700px;margin:0 auto;">
        <div style="margin-bottom:8px;">
          <label for="signupName" style="font-size:14px;">Name:</label><br>
          <input id="signupName" type="text" autocomplete="off" style="width:100%;text-align:left;">
        </div>

        <div class="address-grid">
          <div>
            <label for="signupStreet">Street</label><br>
            <input id="signupStreet" type="text" autocomplete="off" placeholder="412 17th Avenue">
          </div>
          <div>
            <label for="signupCity">City</label><br>
            <input id="signupCity" type="text" autocomplete="off" placeholder="Hinton">
          </div>
          <div>
            <label for="signupState">State/Province</label><br>
            <select id="signupState">
              <option value="">-- Select --</option>
              <!-- US states -->
              <option value="AL">Alabama (AL)</option><option value="AK">Alaska (AK)</option><option value="AZ">Arizona (AZ)</option>
              <option value="AR">Arkansas (AR)</option><option value="CA">California (CA)</option><option value="CO">Colorado (CO)</option>
              <option value="CT">Connecticut (CT)</option><option value="DE">Delaware (DE)</option><option value="FL">Florida (FL)</option>
              <option value="GA">Georgia (GA)</option><option value="HI">Hawaii (HI)</option><option value="ID">Idaho (ID)</option>
              <option value="IL">Illinois (IL)</option><option value="IN">Indiana (IN)</option><option value="IA">Iowa (IA)</option>
              <option value="KS">Kansas (KS)</option><option value="KY">Kentucky (KY)</option><option value="LA">Louisiana (LA)</option>
              <option value="ME">Maine (ME)</option><option value="MD">Maryland (MD)</option><option value="MA">Massachusetts (MA)</option>
              <option value="MI">Michigan (MI)</option><option value="MN">Minnesota (MN)</option><option value="MS">Mississippi (MS)</option>
              <option value="MO">Missouri (MO)</option><option value="MT">Montana (MT)</option><option value="NE">Nebraska (NE)</option>
              <option value="NV">Nevada (NV)</option><option value="NH">New Hampshire (NH)</option><option value="NJ">New Jersey (NJ)</option>
              <option value="NM">New Mexico (NM)</option><option value="NY">New York (NY)</option><option value="NC">North Carolina (NC)</option>
              <option value="ND">North Dakota (ND)</option><option value="OH">Ohio (OH)</option><option value="OK">Oklahoma (OK)</option>
              <option value="OR">Oregon (OR)</option><option value="PA">Pennsylvania (PA)</option><option value="RI">Rhode Island (RI)</option>
              <option value="SC">South Carolina (SC)</option><option value="SD">South Dakota (SD)</option><option value="TN">Tennessee (TN)</option>
              <option value="TX">Texas (TX)</option><option value="UT">Utah (UT)</option><option value="VT">Vermont (VT)</option>
              <option value="VA">Virginia (VA)</option><option value="WA">Washington (WA)</option><option value="WV">West Virginia (WV)</option>
              <option value="WI">Wisconsin (WI)</option><option value="WY">Wyoming (WY)</option><option value="DC">District of Columbia (DC)</option>
              <!-- Canada -->
              <option value="AB">Alberta (AB)</option><option value="BC">British Columbia (BC)</option><option value="MB">Manitoba (MB)</option>
              <option value="NB">New Brunswick (NB)</option><option value="NL">Newfoundland and Labrador (NL)</option><option value="NS">Nova Scotia (NS)</option>
              <option value="NT">Northwest Territories (NT)</option><option value="NU">Nunavut (NU)</option><option value="ON">Ontario (ON)</option>
              <option value="PE">Prince Edward Island (PE)</option><option value="QC">Quebec (QC)</option><option value="SK">Saskatchewan (SK)</option>
              <option value="YT">Yukon (YT)</option>
            </select>
          </div>
          <div>
            <label for="signupZip">ZIP / Postal</label><br>
            <input id="signupZip" type="text" maxlength="12" autocomplete="off" placeholder="25951">
          </div>
        </div>

        <div style="margin-bottom:8px;margin-top:10px;">
          <label for="signupCode" style="font-size:14px;">Your 4-digit code (you choose it):</label><br>
          <input id="signupCode" type="text" maxlength="8" autocomplete="off" inputmode="numeric"
                 placeholder="1234" style="width:160px;text-align:center;">
        </div>

        <div style="margin-bottom:8px;">
          <label for="signupPay" style="font-size:14px;">How will you send your deposit?</label>
          <select id="signupPay">
            <option value="">-- Select --</option>
            <option value="PayPal">PayPal</option>
            <option value="Cash App">Cash App</option>
            <option value="Venmo">Venmo</option>
          </select>
        </div>

        <div class="small-note" style="margin:10px 0 6px 0; text-align:center;">
          You will be redirected to chosen deposit method on sign up.
        </div>

        <div style="text-align:center;">
          <button type="submit">‚úÖ Submit Sign Up</button>
        </div>
      </form>

      <div id="signupStatus" class="status"></div>
    </div>
  </div>

  <!-- Public list card -->
  <div class="card">
    <h2 style="margin-top:0;">Sign-Up List</h2>
    <table class="list-table" id="publicTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>State</th>
          <th>Deposit</th>
        </tr>
      </thead>
      <tbody id="publicTableBody"></tbody>
    </table>
  </div>

  <!-- Admin section (GOOGLE LOGIN ONLY ‚Äî NO CODE UNLOCK) -->
  <div id="adminPanel" class="card">
    <div class="admin-header">
      <h2>Organizer (Admin)</h2>
      <button id="toggleAdminBtn" class="btn-secondary" type="button" style="margin-top:0;">Hide Admin Panel</button>
    </div>

    <button id="adminLoginBtn" type="button" onclick="adminLogin()">Admin Sign In</button>
    <button id="adminLogoutBtn" type="button" onclick="adminLogout()" style="display:none;">Sign Out</button>

    <!-- Admin tools (only visible when signed in) -->
    <div id="adminTools" style="display:none;margin-top:14px;">
      <h3 style="margin:0 0 6px 0;font-size:15px;">Sign-Ups (Admin View)</h3>
      <p class="admin-small-note">Click ‚ÄúApproved‚Äù to mark deposits as verified.</p>

      <table class="list-table" id="adminTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Address</th>
            <th>State</th>
            <th>Code</th>
            <th>Pay Method</th>
            <th>Admin Approved?</th>
            <th>Tracking #</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
      </table>

      <h3 style="margin:16px 0 6px 0;font-size:15px;">Assignments Preview (Approved Only)</h3>
      <p class="admin-small-note">
        Click rows you don‚Äôt like and re-generate until you‚Äôre satisfied.
        Commit Assignments: saves the assignments and starts the exchange.
      </p>

      <div style="margin-bottom:8px;">
        <button id="generatePreviewBtn" class="btn-secondary" type="button">üé≤ Preview Assignments</button>
        <button id="commitAssignmentsBtn" class="btn-secondary" type="button">‚úÖ Commit Assignments</button>
      </div>

      <table class="list-table" id="previewTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Sender</th>
            <th></th>
            <th>Receiver</th>
          </tr>
        </thead>
        <tbody id="previewTableBody"></tbody>
      </table>

      <div style="margin-top:10px;">
        <button id="clearAllBtn" class="btn-danger" type="button">üóë Clear All Sign-Ups &amp; Reset</button>
      </div>

      <div id="adminStatus" class="status" style="text-align:left;"></div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
// ===== Firebase config ‚Äì your project =====
const firebaseConfig = {
  apiKey: "AIzaSyDVlyLssFBefRTRWMNFtNJG7uKNKsWEqDA",
  authDomain: "rock-exchange.firebaseapp.com",
  projectId: "rock-exchange",
  storageBucket: "rock-exchange.firebasestorage.app",
  messagingSenderId: "916313020352",
  appId: "1:916313020352:web:48c363939a1b923a751a25",
  measurementId: "G-LS6C7PX4G4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== Admin Google Sign-In (COMPAT) =====
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

let adminLoginInProgress = false;

function adminLogin() {
  if (adminLoginInProgress) return;
  adminLoginInProgress = true;

  const btn = document.getElementById("adminLoginBtn");
  if (btn) btn.disabled = true;

  auth.signInWithPopup(provider)
    .catch(err => {
      console.error("Admin login failed:", err);
      if (err && err.code === "auth/popup-blocked") {
        alert("Popup was blocked. Allow popups for this site, then try again.");
        return;
      }
      if (err && err.code === "auth/cancelled-popup-request") return;
      alert("Admin sign-in failed.");
    })
    .finally(() => {
      adminLoginInProgress = false;
      if (btn) btn.disabled = false;
    });
}

function adminLogout() {
  auth.signOut();
}

// ===== Admin UI wiring (GOOGLE LOGIN ONLY) =====
const adminLoginBtn = document.getElementById("adminLoginBtn");
const adminLogoutBtn = document.getElementById("adminLogoutBtn");
const adminTools = document.getElementById("adminTools");
const toggleAdminBtn = document.getElementById("toggleAdminBtn");

// Toggle hides/shows tools (only if signed in)
if (toggleAdminBtn) {
  toggleAdminBtn.addEventListener("click", () => {
    if (!auth.currentUser) return; // not signed in -> nothing to show
    const isVisible = adminTools.style.display !== "none";
    if (isVisible) {
      adminTools.style.display = "none";
      toggleAdminBtn.textContent = "Show Admin Panel";
    } else {
      adminTools.style.display = "block";
      toggleAdminBtn.textContent = "Hide Admin Panel";
    }
  });
}

auth.onAuthStateChanged(user => {
  if (user) {
    if (adminLoginBtn) adminLoginBtn.style.display = "none";
    if (adminLogoutBtn) adminLogoutBtn.style.display = "inline-block";
    if (adminTools) adminTools.style.display = "block";
    if (toggleAdminBtn) toggleAdminBtn.textContent = "Hide Admin Panel";
  } else {
    if (adminLoginBtn) adminLoginBtn.style.display = "inline-block";
    if (adminLogoutBtn) adminLogoutBtn.style.display = "none";
    if (adminTools) adminTools.style.display = "none";
    if (toggleAdminBtn) toggleAdminBtn.textContent = "Hide Admin Panel";
  }
});

// ===== Payment Links =====
const PAYMENT_LINKS = {
  "PayPal": "PASTE_PAYPAL_LINK_HERE",
  "Cash App": "PASTE_CASHAPP_LINK_HERE",
  "Venmo": "PASTE_VENMO_LINK_HERE",
};

function regionForState(st) {
  const up = (st || "").toUpperCase();
  const stateToRegion = {
    ME:"Northeast", NH:"Northeast", VT:"Northeast", MA:"Northeast",
    RI:"Northeast", CT:"Northeast", NY:"Northeast", NJ:"Northeast",
    PA:"Northeast",

    OH:"Midwest", MI:"Midwest", IN:"Midwest", IL:"Midwest",
    WI:"Midwest", MN:"Midwest", IA:"Midwest", MO:"Midwest",
    ND:"Midwest", SD:"Midwest", NE:"Midwest", KS:"Midwest",

    DE:"South", MD:"South", DC:"South", VA:"South", WV:"South",
    NC:"South", SC:"South", GA:"South", FL:"South",
    KY:"South", TN:"South", AL:"South", MS:"South",
    AR:"South", LA:"South", OK:"South", TX:"South",

    MT:"Mountain", ID:"Mountain", WY:"Mountain", CO:"Mountain",
    NM:"Mountain", AZ:"Mountain", UT:"Mountain", NV:"Mountain",

    WA:"West", OR:"West", CA:"West",

    AK:"Alaska", HI:"Hawaii"
  };
  return stateToRegion[up] || "Unknown";
}

function titleCaseWord(word) {
  if (!word) return "";
  return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
}

function formatName(name) {
  if (!name) return "";
  return name.toLowerCase().replace(/\s+/g, " ").trim().split(" ").map(titleCaseWord).join(" ");
}

function formatCity(city) {
  if (!city) return "";
  return city.toLowerCase().replace(/\s+/g, " ").trim().split(" ").map(titleCaseWord).join(" ");
}

function formatStreet(street) {
  if (!street) return "";
  let cleaned = street.replace(/\s+/g, " ").trim();
  if (!cleaned) return "";

  const suffixMap = {
    "st": "St.", "street": "St.",
    "rd": "Rd.", "road": "Rd.",
    "ave": "Ave.", "avenue": "Ave.",
    "blvd": "Blvd.", "boulevard": "Blvd.",
    "ln": "Ln.", "lane": "Ln.",
    "dr": "Dr.", "drive": "Dr.",
    "ct": "Ct.", "court": "Ct.",
    "pkwy": "Pkwy.", "parkway": "Pkwy.",
    "pl": "Pl.", "place": "Pl."
  };

  const dirMap = { "n":"N","s":"S","e":"E","w":"W","ne":"NE","nw":"NW","se":"SE","sw":"SW" };

  const parts = cleaned.split(" ");
  const out = parts.map(part => {
    let raw = part;
    let trailing = "";
    if (/[.,]$/.test(raw)) { trailing = raw.slice(-1); raw = raw.slice(0, -1); }

    const lower = raw.toLowerCase();
    if (dirMap[lower]) return dirMap[lower] + trailing;
    if (suffixMap[lower]) return suffixMap[lower] + trailing;
    if (/\d/.test(raw)) return raw + trailing;
    return titleCaseWord(raw) + trailing;
  });

  return out.join(" ");
}

// ===== UI elements for reveal vs signup =====
const revealSection = document.getElementById("revealSection");
const signupSection = document.getElementById("signupSection");

db.collection("settings").doc("global").onSnapshot((snap) => {
  let revealEnabled = false;
  if (snap.exists) revealEnabled = !!(snap.data() || {}).revealEnabled;

  if (revealEnabled) {
    revealSection.style.display = "block";
    signupSection.style.display = "none";
  } else {
    revealSection.style.display = "none";
    signupSection.style.display = "block";
  }
}, (err) => {
  console.error("settings/global listener error:", err);
});

// ===== SIGN-UP LOGIC =====
const showSignupBtn = document.getElementById("showSignupBtn");
const signupForm = document.getElementById("signupForm");
const signupStatus = document.getElementById("signupStatus");

showSignupBtn.addEventListener("click", () => {
  signupForm.style.display = "block";
  showSignupBtn.style.display = "none";
});

signupForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  signupStatus.textContent = "";
  signupStatus.className = "status";

  let name = document.getElementById("signupName").value.trim();
  let street = document.getElementById("signupStreet").value.trim();
  let city = document.getElementById("signupCity").value.trim();
  const stateCode = document.getElementById("signupState").value.trim();
  const zip = document.getElementById("signupZip").value.trim();
  const code = document.getElementById("signupCode").value.trim();
  const payment = document.getElementById("signupPay").value;

  if (!name || !street || !city || !stateCode || !zip || !code || !payment) {
    signupStatus.textContent = "Please fill in all fields (name, full address, code, payment method).";
    signupStatus.classList.add("error");
    return;
  }

  name = formatName(name);
  street = formatStreet(street);
  city = formatCity(city);

  const addressFull = `${street}, ${city}, ${stateCode} ${zip}`;

  try {
    await db.collection("signups").add({
      name,
      addressStreet: street,
      addressCity: city,
      addressStateCode: stateCode,
      addressZip: zip,
      addressFull,
      state: stateCode,
      code,
      paymentMethod: payment,
      depositSent: false,
      depositApproved: false,
      trackingNumber: "",
      trackingSubmitted: false,
      trackingSubmittedAt: null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      assignedToId: null,
      assignedToName: null,
      assignedToAddressFull: null,
      assignedToState: null,
      assignedAt: null
    });

    signupStatus.innerHTML = `‚úÖ <strong>Sign-up successful!</strong><br>`;
    signupStatus.classList.add("success");

    signupForm.reset();
    signupForm.style.display = "none";
    showSignupBtn.style.display = "inline-block";

    setTimeout(() => openPayment(payment), 150);
  } catch (err) {
    console.error(err);
    signupStatus.textContent = "Error saving sign-up. Please try again or contact the organizer.";
    signupStatus.classList.add("error");
  }
});

// ===== REVEAL MATCH + TRACKING =====
const revealCodeInput = document.getElementById("revealCodeInput");
const revealBtn = document.getElementById("revealBtn");
const revealStatus = document.getElementById("revealStatus");
const revealResultCard = document.getElementById("revealResultCard");
const trackingSection = document.getElementById("trackingSection");
const trackingInput = document.getElementById("trackingInput");
const submitTrackingBtn = document.getElementById("submitTrackingBtn");
const trackingStatus = document.getElementById("trackingStatus");
const incomingTrackingDisplay = document.getElementById("incomingTrackingDisplay");

let currentRevealDocId = null;

async function loadIncomingTracking(myDocId) {
  incomingTrackingDisplay.textContent = "";
  try {
    const snap = await db.collection("signups")
      .where("assignedToId", "==", myDocId)
      .limit(1)
      .get();

    if (snap.empty) {
      incomingTrackingDisplay.textContent = "Tracking number for the box coming to you: (not submitted yet)";
      return;
    }

    const d = snap.docs[0].data();
    if (d.trackingSubmitted && d.trackingNumber) {
      incomingTrackingDisplay.textContent = "Tracking number for the box coming to you: " + d.trackingNumber;
    } else {
      incomingTrackingDisplay.textContent = "Tracking number for the box coming to you: (not submitted yet)";
    }
  } catch (err) {
    console.error(err);
    incomingTrackingDisplay.textContent = "Unable to load tracking for your incoming package right now.";
  }
}

async function revealMatch() {
  revealStatus.textContent = "";
  revealStatus.className = "status";
  revealResultCard.style.display = "none";
  revealResultCard.textContent = "";
  trackingSection.style.display = "none";
  trackingStatus.textContent = "";
  trackingStatus.className = "status";
  incomingTrackingDisplay.textContent = "";
  currentRevealDocId = null;

  const code = revealCodeInput.value.trim();
  if (!code) {
    revealStatus.textContent = "Please enter your code.";
    revealStatus.classList.add("error");
    return;
  }

  try {
    const settingsSnap = await db.collection("settings").doc("global").get();
    const revealEnabled = settingsSnap.exists && !!(settingsSnap.data() || {}).revealEnabled;
    if (!revealEnabled) {
      revealStatus.textContent = "Assignments are not revealed yet. Please wait for the organizer to enable reveal.";
      revealStatus.classList.add("error");
      return;
    }

    const snap = await db.collection("signups").where("code", "==", code).limit(1).get();
    if (snap.empty) {
      revealStatus.textContent = "No sign-up found with that code. Double-check or contact the organizer.";
      revealStatus.classList.add("error");
      return;
    }

    const doc = snap.docs[0];
    const d = doc.data();
    currentRevealDocId = doc.id;

    const toName = d.assignedToName;
    const toAddr = d.assignedToAddressFull || d.assignedToAddress || "";

    if (!toName || !toAddr) {
      revealStatus.textContent = "You are signed up, but assignments are not ready yet. Please contact the organizer.";
      revealStatus.classList.add("error");
      return;
    }

    revealStatus.textContent = "Match found!";
    revealStatus.classList.add("success");

    revealResultCard.innerHTML =
      `<div><strong>Hello ${d.name}!</strong></div>` +
      `<div style="margin-top:6px;">For this Rock Exchange, you'll be sending rocks to:</div>` +
      `<div style="margin-top:6px;padding-left:8px;"><strong>${toName}</strong><br>${toAddr}</div>` +
      `<div style="margin-top:10px;font-size:12px;color:#475569;">` +
      `Please mail your box on or before Dec. 12. Submit a valid tracking number and I will refund your deposit.` +
      `</div>` +
      `<div style="margin-top:6px;font-size:12px;color:#475569;">Thank you for being part of this Exchange!</div>`;

    revealResultCard.style.display = "block";
    revealResultCard.classList.remove("fade-in");
    void revealResultCard.offsetWidth;
    revealResultCard.classList.add("fade-in");

    trackingInput.value = d.trackingNumber || "";
    trackingSection.style.display = "block";

    await loadIncomingTracking(doc.id);
  } catch (err) {
    console.error(err);
    revealStatus.textContent = "Error looking up your assignment. Please try again.";
    revealStatus.classList.add("error");
  }
}

revealBtn.addEventListener("click", revealMatch);
revealCodeInput.addEventListener("keyup", (e) => { if (e.key === "Enter") revealMatch(); });

submitTrackingBtn.addEventListener("click", async () => {
  trackingStatus.textContent = "";
  trackingStatus.className = "status";

  if (!currentRevealDocId) {
    trackingStatus.textContent = "Please reveal your match first.";
    trackingStatus.classList.add("error");
    return;
  }

  const trackingNumber = trackingInput.value.trim();
  if (!trackingNumber) {
    trackingStatus.textContent = "Please enter a tracking number.";
    trackingStatus.classList.add("error");
    return;
  }

  try {
    await db.collection("signups").doc(currentRevealDocId).update({
      trackingNumber,
      trackingSubmitted: true,
      trackingSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    trackingStatus.textContent = "Tracking number submitted. Thank you!";
    trackingStatus.classList.add("success");

    await loadIncomingTracking(currentRevealDocId);
  } catch (err) {
    console.error(err);
    trackingStatus.textContent = "Error saving tracking number. Please try again.";
    trackingStatus.classList.add("error");
  }
});

// ===== REAL-TIME LISTENERS FOR PUBLIC + ADMIN TABLES =====
function fullStateName(code) {
  const c = (code || "").toUpperCase().trim();
  const map = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California",
    CO:"Colorado", CT:"Connecticut", DE:"Delaware", FL:"Florida", GA:"Georgia",
    HI:"Hawaii", ID:"Idaho", IL:"Illinois", IN:"Indiana", IA:"Iowa",
    KS:"Kansas", KY:"Kentucky", LA:"Louisiana", ME:"Maine", MD:"Maryland",
    MA:"Massachusetts", MI:"Michigan", MN:"Minnesota", MS:"Mississippi", MO:"Missouri",
    MT:"Montana", NE:"Nebraska", NV:"Nevada", NH:"New Hampshire", NJ:"New Jersey",
    NM:"New Mexico", NY:"New York", NC:"North Carolina", ND:"North Dakota", OH:"Ohio",
    OK:"Oklahoma", OR:"Oregon", PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina",
    SD:"South Dakota", TN:"Tennessee", TX:"Texas", UT:"Utah", VT:"Vermont",
    VA:"Virginia", WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming",
    DC:"District of Columbia",
    AB:"Alberta", BC:"British Columbia", MB:"Manitoba", NB:"New Brunswick",
    "NL":"Newfoundland and Labrador", NS:"Nova Scotia", NT:"Northwest Territories",
    NU:"Nunavut", ON:"Ontario", PE:"Prince Edward Island", QC:"Quebec",
    SK:"Saskatchewan", YT:"Yukon"
  };
  return map[c] || (code || "‚Äî");
}

const publicTableBody = document.getElementById("publicTableBody");
const adminTableBody = document.getElementById("adminTableBody");
const adminStatus = document.getElementById("adminStatus");

db.collection("signups")
  .orderBy("createdAt", "asc")
  .onSnapshot((snapshot) => {
    const rowsPublic = [];
    const rowsAdmin = [];
    let idx = 0;

    snapshot.forEach(doc => {
      idx++;
      const d = doc.data();

      const name = d.name || "";
      const stateCode = d.addressStateCode || d.state || "";
      const stateFull = fullStateName(stateCode);

      const pm = d.paymentMethod || "";
      const depositApproved = !!d.depositApproved;
      const trackingNumber = d.trackingNumber || "";
      const addressFull = d.addressFull || d.address || "";
      const code = d.code || "";

      const trPub = document.createElement("tr");
      trPub.innerHTML = `
        <td>${idx}</td>
        <td>${name}</td>
        <td>${stateFull}</td>
        <td>
          <span class="badge ${depositApproved ? "badge-approved" : "badge-not-approved"}">
            ${depositApproved ? "Approved" : "Pending"}
          </span>
        </td>
      `;
      rowsPublic.push(trPub);

      const trAdmin = document.createElement("tr");
      trAdmin.setAttribute("data-id", doc.id);
      trAdmin.innerHTML = `
        <td>${idx}</td>
        <td>${name}</td>
        <td style="max-width:260px;white-space:normal;">${addressFull}</td>
        <td>${stateCode}</td>
        <td>${code || "‚Äî"}</td>
        <td>${pm || "‚Äî"}</td>
        <td>
          <span class="badge clickable ${depositApproved ? "badge-approved" : "badge-not-approved"}">
            ${depositApproved ? "Approved" : "Click to Approve"}
          </span>
        </td>
        <td>${trackingNumber ? trackingNumber : "‚Äî"}</td>
        <td>
          <button class="btn-small btn-danger btn-delete" type="button">Delete</button>
        </td>
      `;
      rowsAdmin.push(trAdmin);
    });

    publicTableBody.innerHTML = "";
    rowsPublic.forEach(r => publicTableBody.appendChild(r));

    adminTableBody.innerHTML = "";
    rowsAdmin.forEach(r => adminTableBody.appendChild(r));

    attachAdminRowHandlers();
  }, (err) => {
    console.error("Error listening to signups:", err);
  });

function attachAdminRowHandlers() {
  const rows = Array.from(adminTableBody.querySelectorAll("tr"));
  rows.forEach(row => {
    const docId = row.getAttribute("data-id");
    if (!docId) return;

    const approveBadge = row.querySelector(".badge.clickable");
    if (approveBadge) {
      approveBadge.addEventListener("click", async () => {
        // only allow if signed in
        if (!auth.currentUser) return;

        const alreadyApproved = approveBadge.classList.contains("badge-approved");
        if (alreadyApproved) return;

        try {
          await db.collection("signups").doc(docId).update({ depositApproved: true });
          adminStatus.textContent = "Deposit approved.";
          adminStatus.className = "status success";
        } catch (err) {
          console.error(err);
          adminStatus.textContent = "Error approving deposit.";
          adminStatus.className = "status error";
        }
      });
    }

    const deleteBtn = row.querySelector(".btn-delete");
    if (deleteBtn) {
      deleteBtn.addEventListener("click", async () => {
        if (!auth.currentUser) return;
        const confirmed = confirm("Delete this sign-up? This cannot be undone.");
        if (!confirmed) return;

        try {
          await db.collection("signups").doc(docId).delete();
          adminStatus.textContent = "Sign-up deleted.";
          adminStatus.className = "status success";
        } catch (err) {
          console.error(err);
          adminStatus.textContent = "Error deleting sign-up.";
          adminStatus.className = "status error";
        }
      });
    }
  });
}

// ===== ASSIGNMENTS PREVIEW (ADMIN) =====
const generatePreviewBtn = document.getElementById("generatePreviewBtn");
const commitAssignmentsBtn = document.getElementById("commitAssignmentsBtn");
const previewTableBody = document.getElementById("previewTableBody");

let previewParticipants = null;
let previewAssignments = null;
let selectedPreviewFromIndices = new Set();

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function generateAssignments(participants) {
  const n = participants.length;
  if (n < 2) return null;

  const idxs = [...Array(n).keys()];
  let bestPerm = null;
  let bestScore = Infinity;
  const maxTries = 500;

  function score(perm) {
    let selfSend = 0;
    let regionConf = 0;
    let twoCycles = 0;

    for (let i = 0; i < n; i++) {
      const j = perm[i];
      if (i === j) selfSend++;
      const a = participants[i];
      const b = participants[j];
      if (a.region !== "Unknown" && b.region !== "Unknown" && a.region === b.region) regionConf++;
    }

    for (let i = 0; i < n; i++) {
      const j = perm[i];
      if (j > i && perm[j] === i) twoCycles++;
    }

    return selfSend * 10000 + twoCycles * 100 + regionConf;
  }

  for (let attempt = 0; attempt < maxTries; attempt++) {
    shuffle(idxs);
    const perm = idxs.slice();
    const s = score(perm);
    if (s < bestScore) {
      bestScore = s;
      bestPerm = perm.slice();
      if (s === 0) break;
    }
  }

  if (!bestPerm) return null;

  for (let i = 0; i < n; i++) {
    if (bestPerm[i] === i) {
      const j = (i + 1) % n;
      [bestPerm[i], bestPerm[j]] = [bestPerm[j], bestPerm[i]];
    }
  }

  const assignments = [];
  for (let i = 0; i < n; i++) assignments.push({ fromIndex: i, toIndex: bestPerm[i] });
  return assignments;
}

function rerollSubsetAssignments(participants, assignments, selectedFromIdxArr) {
  const n = participants.length;
  if (selectedFromIdxArr.length < 2) return false;

  const dest = new Array(n);
  for (let i = 0; i < n; i++) dest[i] = assignments[i].toIndex;

  const S = selectedFromIdxArr;
  const m = S.length;
  const pool = S.map(i => dest[i]);

  const maxTries = 400;
  let bestMap = null;
  let bestScore = Infinity;

  function scoreMapping(perm) {
    const tempDest = dest.slice();
    for (let k = 0; k < m; k++) {
      const fromIdx = S[k];
      const toIdx = pool[perm[k]];
      tempDest[fromIdx] = toIdx;
    }

    let selfSend = 0;
    let regionConf = 0;
    let twoCycles = 0;

    for (let i = 0; i < n; i++) {
      const j = tempDest[i];
      if (i === j) selfSend++;
      const a = participants[i];
      const b = participants[j];
      if (a.region !== "Unknown" && b.region !== "Unknown" && a.region === b.region) regionConf++;
    }

    for (let i = 0; i < n; i++) {
      const j = tempDest[i];
      if (j > i && tempDest[j] === i) twoCycles++;
    }

    return selfSend * 10000 + twoCycles * 100 + regionConf;
  }

  for (let attempt = 0; attempt < maxTries; attempt++) {
    const perm = [...Array(m).keys()];
    shuffle(perm);

    let bad = false;
    for (let k = 0; k < m; k++) {
      const fromIdx = S[k];
      const toIdx = pool[perm[k]];
      if (toIdx === fromIdx) { bad = true; break; }
    }
    if (bad) continue;

    const sc = scoreMapping(perm);
    if (sc < bestScore) {
      bestScore = sc;
      bestMap = perm.slice();
      if (sc === 0) break;
    }
  }

  if (!bestMap) return false;

  for (let k = 0; k < m; k++) {
    const fromIdx = S[k];
    const toIdx = pool[bestMap[k]];
    dest[fromIdx] = toIdx;
  }

  for (let i = 0; i < n; i++) assignments[i].toIndex = dest[i];
  return true;
}

function renderPreviewTable(participants, assignments) {
  previewTableBody.innerHTML = "";
  selectedPreviewFromIndices.clear();

  assignments.forEach((a, idx) => {
    const from = participants[a.fromIndex];
    const to = participants[a.toIndex];

    const tr = document.createElement("tr");
    tr.className = "preview-row";
    tr.setAttribute("data-from-index", String(a.fromIndex));
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${from.name} (${from.stateCode})</td>
      <td style="text-align:center;">‚Üí</td>
      <td>${to.name} (${to.stateCode})</td>
    `;
    previewTableBody.appendChild(tr);
  });

  attachPreviewRowHandlers();
}

function attachPreviewRowHandlers() {
  const rows = Array.from(previewTableBody.querySelectorAll("tr.preview-row"));
  rows.forEach(row => {
    row.addEventListener("click", () => {
      const fromIdx = parseInt(row.getAttribute("data-from-index"), 10);
      if (selectedPreviewFromIndices.has(fromIdx)) {
        selectedPreviewFromIndices.delete(fromIdx);
        row.classList.remove("preview-row-selected");
      } else {
        selectedPreviewFromIndices.add(fromIdx);
        row.classList.add("preview-row-selected");
      }
    });
  });
}

function sameParticipantSet(oldList, newList) {
  if (!oldList) return false;
  if (oldList.length !== newList.length) return false;
  const oldIds = oldList.map(p => p.id).sort();
  const newIds = newList.map(p => p.id).sort();
  for (let i = 0; i < oldIds.length; i++) if (oldIds[i] !== newIds[i]) return false;
  return true;
}

generatePreviewBtn.addEventListener("click", async () => {
  if (!auth.currentUser) return;

  adminStatus.textContent = "";
  adminStatus.className = "status";

  try {
    const snap = await db.collection("signups").where("depositApproved", "==", true).get();

    if (snap.size < 2) {
      adminStatus.textContent = "Need at least 2 approved participants to generate assignments.";
      adminStatus.classList.add("error");
      previewTableBody.innerHTML = "";
      previewParticipants = null;
      previewAssignments = null;
      selectedPreviewFromIndices.clear();
      return;
    }

    const participantsNow = [];
    snap.forEach(doc => {
      const d = doc.data();
      const stateCode = d.addressStateCode || d.state || "";
      participantsNow.push({
        id: doc.id,
        name: d.name || "",
        addressFull: d.addressFull || d.address || "",
        stateCode,
        region: regionForState(stateCode),
        code: d.code || ""
      });
    });

    if (!previewParticipants || !previewAssignments || !sameParticipantSet(previewParticipants, participantsNow)) {
      const assignments = generateAssignments(participantsNow);
      if (!assignments) {
        adminStatus.textContent = "Could not generate assignments. Try again.";
        adminStatus.classList.add("error");
        previewTableBody.innerHTML = "";
        previewParticipants = null;
        previewAssignments = null;
        selectedPreviewFromIndices.clear();
        return;
      }

      previewParticipants = participantsNow;
      previewAssignments = assignments;
      renderPreviewTable(previewParticipants, previewAssignments);

      adminStatus.textContent = "Preview assignments generated. Click rows, then click Preview Assignments again to re-roll.";
      adminStatus.classList.add("success");
      return;
    }

    previewParticipants = participantsNow;
    const selected = Array.from(selectedPreviewFromIndices);

    if (selected.length === 0) {
      const assignments = generateAssignments(previewParticipants);
      if (!assignments) {
        adminStatus.textContent = "Could not re-roll assignments. Try again.";
        adminStatus.classList.add("error");
        return;
      }
      previewAssignments = assignments;
      renderPreviewTable(previewParticipants, previewAssignments);
      adminStatus.textContent = "Entire preview re-rolled.";
      adminStatus.classList.add("success");
    } else if (selected.length === 1) {
      adminStatus.textContent = "Select at least 2 rows to re-roll subset.";
      adminStatus.classList.add("error");
    } else {
      const ok = rerollSubsetAssignments(previewParticipants, previewAssignments, selected);
      if (!ok) {
        adminStatus.textContent = "Could not find a better subset re-roll. Try selecting a different group or re-roll all.";
        adminStatus.classList.add("error");
        return;
      }
      renderPreviewTable(previewParticipants, previewAssignments);
      adminStatus.textContent = "Selected preview rows re-rolled.";
      adminStatus.classList.add("success");
    }
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error generating preview assignments. Please try again.";
    adminStatus.classList.add("error");
  }
});

commitAssignmentsBtn.addEventListener("click", async () => {
  if (!auth.currentUser) return;

  adminStatus.textContent = "";
  adminStatus.className = "status";

  if (!previewParticipants || !previewAssignments) {
    adminStatus.textContent = "No preview assignments to commit. Generate a preview first.";
    adminStatus.classList.add("error");
    return;
  }

  const confirmed = confirm(
    "This will save the current preview assignments for all approved participants and enable the reveal page.\n" +
    "Sign-ups will effectively be closed. Continue?"
  );
  if (!confirmed) return;

  try {
    const batch = db.batch();

    previewAssignments.forEach(a => {
      const from = previewParticipants[a.fromIndex];
      const to = previewParticipants[a.toIndex];
      const ref = db.collection("signups").doc(from.id);
      batch.update(ref, {
        assignedToId: to.id,
        assignedToName: to.name,
        assignedToAddressFull: to.addressFull,
        assignedToState: to.stateCode,
        assignedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    const settingsRef = db.collection("settings").doc("global");
    batch.set(settingsRef, {
      revealEnabled: true,
      lastAssignmentsAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    await batch.commit();

    adminStatus.textContent = "Assignments committed and reveal has been enabled.";
    adminStatus.classList.add("success");
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error committing assignments. Please try again.";
    adminStatus.classList.add("error");
  }
});

// ===== CLEAR ALL SIGN-UPS & RESET (ADMIN) =====
const clearAllBtn = document.getElementById("clearAllBtn");

clearAllBtn.addEventListener("click", async () => {
  if (!auth.currentUser) return;

  adminStatus.textContent = "";
  adminStatus.className = "status";

  const confirmed = confirm(
    "This will delete ALL sign-ups and reset reveal settings.\n" +
    "Only do this if you want to completely reset the swap.\n\n" +
    "Are you sure?"
  );
  if (!confirmed) return;

  try {
    const snap = await db.collection("signups").get();
    const batch = db.batch();

    snap.forEach(doc => batch.delete(doc.ref));

    const settingsRef = db.collection("settings").doc("global");
    batch.set(settingsRef, { revealEnabled: false, lastAssignmentsAt: null }, { merge: true });

    await batch.commit();

    previewTableBody.innerHTML = "";
    previewParticipants = null;
    previewAssignments = null;
    selectedPreviewFromIndices.clear();

    adminStatus.textContent = "All sign-ups cleared and swap reset.";
    adminStatus.classList.add("success");
  } catch (err) {
    console.error(err);
    adminStatus.textContent = "Error clearing sign-ups. Please try again.";
    adminStatus.classList.add("error");
  }
});

function openPayment(method) {
  const links = {
    "PayPal": "https://paypal.me/donnapevey1",
    "Cash App": "https://cash.app/$donnapevey",
    "Venmo": "https://venmo.com/u/Donnapevey00"
  };

  const url = links[method];
  if (url) window.open(url, "_blank", "noopener,noreferrer");
  else alert("Payment link not set for: " + method);
}
</script>
</body>
</html>
